      //crea il canvas
      var canvasWidth = 720;
      var canvasHeight = 540;
      if(document.getElementsByTagName('canvas').length == 0) {     //crea il canvas con le variabili che ho creato
          document.body.innerHTML += "".concat("<canvas id='canvas' width=" , canvasWidth , " height=" , canvasHeight , "></canvas>");
      }   var ctx = document.getElementById('canvas').getContext('2d');

	  //variabili dei tasti
      var keys = [];            //vettore tasti
      var tastoGiaSchiacciato = false; //mi serve per alcune funzioni tipo selectScreen()
      var jumpkey = 90;         //salta - default z
      var destrakey = 39;       //muovi sinistra - default freccia destra
      var sinistrakey = 37;     //muovi destra - default freccia sinistra
      var sukey = 38;           //default freccia su
      var giukey = 40;          //default freccia giu
      var dashkey = 88;		    //dash - default x
      var sparokey = 65;		//shoot - default a
      var startkey = 13;		//start - default INVIO/ENTER

      document.body.addEventListener("keydown", function(e) {//events - leggi tasti schiacciati
          keys[e.keyCode] = true;
      });
          document.body.addEventListener("keyup", function(e) {//events - leggi tasti rilasciati
          keys[e.keyCode] = false;
      });

      //prototipo del player
      function Player() {
      	this.life=16;
      	this.lifeMax=16;
        this.x= 0;
        this.y= 0;
        this.yv= 0;
        this.xv= 0;
        this.slope= 0;
        this.width= 24;
        this.height= 38;
        this.color= '#0400f8';
        this.defaultColor= '#0400f8';
        this.damagedColor= '#990003';
        this.charge0color= '#ffc000';
        this.charge1color= '#49ff37';
        this.charge2color= '#14dfff';        
        this.speed= 0.9;
        this.defaultspeed= 0.9;
        this.jumpheight= 11.5;
        this.giasaltato = false;
        this.giasparato = false;
        this.facingRight = true;
        this.isInWater = false;
        this.invulnerability = 0;
        this.canMove = true;
        this.carica = 0;
      }
      var player = new Player(); //creo il player

  //gamestate - se tutto i gamestate sono false lo stato e' "in gioco"
  var stageSelection=true; //stato: selezione del livello
  var menuDiPausa=false; var objMenuDiPausa=new newMenuDiPausa(); //stato: menu di pausa - inoltre inizializza l'oggetto che lo gestisce

	//caricare il livello
	var level = []; //create the level array
	var lvlNumber=1;
      					
    //prendo lvlNumber e carico il livello scelto - sadly non ancora da file perch√® siamo a corto di budget
	function leggiLivelloDaFile() {	//funz che carica il livello scelto - i livello sono salvati come stringhe
		switch (lvlNumber) {
			case 1: stringToLevel("tttttttttttttttttttttttttttttttttttttttttttttttttttl...................................................l...................................................l..................................................l..................................................l......................................P...........l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..............................P...................l..X.................................P.............l..................................................z0.62;0.85;");
				break;

			case 2: stringToLevel("tttttttttttttttttttttttttttttttttttttttttttttttttttttttttttl..........................................................l..........................................................l..eeeeeee.................................................l..........................................................l............ggggggg.......................................l..........................................................l.....................fffffff..............................l..........................................................l..........................................................l..............................ggggggg.....................l..........................................................l........................................eeeeeee...........l..........................................................l..................................................aaa.....l..........a...............................................l..........a.......h...h..ccccc.ddd.ccc.d.d.c.ddd.c.c.....fl..........a...bbb.h.h.h..c.....d.d.c.c.d.d....d..c.c......l..........a...b.b.h.h.h..c..cc.dd..ccc.d.d.c..d...c.......l..........aaa.bbb..h.h...c...c.d.d.c.c..d..c..d...c.......l.........................cccc.............................l.........................................................gl..........................................................l..........................................................l...........................cccccccccccccccccccccccccccc...l....X.....................................................l....................bb....................................l................bb........................................l............gg............................................l........ff................................................l....ee....................................................z0.25;0.85;moon.jpg;#2F4858;#716F71;#81B2C5;#6D98BA;#EACDC2;#ebdb9d;#d6ba54;#490047;");
				break;

			case 3: stringToLevel("ttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttl...................................................................................................................................................................................................................l...................................................................................................................................................................................................................l...................................................................................................................................................................................................................l..j...j.kkk.jjj.k...jj...kkk...j.....kkk...j.......................................................................................................................................................................l..j...j.k.k.j.j.k...j.j..k.k..jj.....k.k..jj.......................................................................................................................................................................l..j.j.j.k.k.jjj.k...j.j..k.k.j.j.iii.k.k.j.j.......................................................................................................................................................................l..j.j.j.k.k.jj..k...j.j..k.k...j.....k.k...j.......................................................................................................................................................................l...j.j..kkk.j.j.kkk.jj...kkk...j.....kkk...j.......................................................................................................................................................................l...................................................................................................................................................................................................................l...................................................................................................................................................................................................................l.........................................................................................................................................................................................................f.........l.........................................................................................................................................................................................................hi........l.........................................................................................................................................................................................................hii.......l................................................................................................................................................................................................gg.......h.........l...............................................................................................................................................................................................ggg.......h.........l......................d.........................................................dddddddd...dddd................e............ddd....dddd.......................................................gggg.......h.........l.............................................................................................................................................................................................ggggg.......h...g.g.g.l.............................................ffff.......ffff................................................................................g..g..........gg..g.............................gggggg.......h...ggggg.l...............d....deddd............ffff.....ff.........ff..................ddd..............e......dd.....e..e..e.....d...........de.....gg..gg........ggg..gg...........dddd............ggggggg.......h...ggggg.l.X.........................ffff.......ff......ff.........ff...............................................................................ggg..ggg......gggg..ggg....ffff............ffff.gggggggg.......h...gg.gg.l............................ff........ff......ff.........ff..............................................................................gggg..gggg....ggggg..gggg....ff..............ff.ggggggggg......ggg..gg.gg.lccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc..ccccccccccccccc...ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc..ccccccccccccccccccccccccccccccccccccccccccccccccccccclbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbc..cbbbbbbbbbbbbbc...cbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbc..cbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbblbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..bbbbbbbbbbbbbbb...bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbblbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..bbbbbbbbbbbbbbb...bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbblbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..bbbbbbbbbbbbbbb...bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbblbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..bbbbbbbbbbbbbbb...bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbblbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbSSbbbbbbbbbbbbbbbSSSbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbSSbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbz0.62;0.85;sunnySky.png;#00000000;#5d4900;#21ad10;#c34e29;#d6ba54;#005f00;#86310e;#bcbcbc;#fcfcfc;#a60000;#402fd6;");
				break;
        
      case 4: stringToLevel("tttttttttttttttttttttttttttttttttttttttttttttttttttl...................................................l..................................................l..................................................l......................................P...........l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................w...bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..................................................l..............................P...................l..X.................................P.............l..................................................z0.62;0.85;");  
        break;
        
			case 7: stringToLevel("ttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttttl...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l..................................................................................................................................................................................................mmmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l...................................................................................................................................................................................................mmmmmcccccccccccccccccccddccccccccccccccccccccc.............................................................................................................................................................l...................................................................................................................................................................................................mmmmmcccccccccccccqqqqqqddccccccccccccccccccccc.............................................................................................................................................................l....................................................................................................................................................................................................mmmmcccccccccccccqqqqqqddccccccccccccccccccccc.............................................................................................................................................................l....................................................................................................................................................................................................mmmmmqccccqqqqqqqqqqqqqddccccccccccccccccccccc.............................................................................................................................................................l....................................................................................................................................................................................................pqmmmqccccqqqqqqqqqqqqqddccccccccccccccccccccc.............................................................................................................................................................l....................................................................................................................................................................................................pqmmmqPqqqqqqqqqqqqqqqqddddddddddddddddddddddd.............................................................................................................................................................l....................................................................................................................................................................................................pqmmmqqqqqqqqqqqqqqqqqqddddddddddddddddddddddd.............................................................................................................................................................l....................................................................................................................................................................................................pqmmmqqqqqqqqqqqqqqqqqqddccccccccccccccccccccc.............................................................................................................................................................l....................................................................................................................................................................................................pqmmmqqqqqqqqqqqqqqqqqqddccccccccccccccccccccc.............................................................................................................................................................l..........................................................................................................bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..........................................................pqmmmqqqqqqqqqqqqqqqqqqddccccccccccccccccccccc.............................................................................................................................................................l..........................................................................................................bccccccccccccccccccccccccccccccc..........................................................pqmmmqqqqqqqqqqqqqqqqqqddccccccccccccccccccccc.............................................................................................................................................................l..........................................................................................................ccccccccccccccccccccccccccccccccbbbb............................................bbbbbbbbbbbbbbddddd..............ddccccccccccccccccccccc.............................................................................................................................................................l..........................................................................................................cccccccccccccccccccccccccccccccccccb............................................ccccccccccccccccccc..............ddccccccccccccccccccccc.............................................................................................................................................................l..............................................bbbbbbbbbbbbbbbbbbbbbbbb....................................cccccccccccccccccccccccccccccccccccc................................bbbbbbbbbbbbccccccccccccccccccc..............ddddddddddddddddddddddd.............................................................................................................................................................l..............................................cccccccccccccccccccccccc....................................cccccccccccccccccccccccccccccccccccc................................ccccccccccccccccccccccccccccccc..............ddddddddddddddddddddddd.............................................................................................................................................................l.X................................bbbbbbbbbbbbccccccccccccccccccccccccbbbb................................cccccccccccccccccccccccccccccccccccc....................bbbbbbbbbbbbcccccccccccccccccccccccccccccccdd............ddccccccccccccccccccccc.............................................................................................................................................................l..................................cccccccccccccccccccccccccccccccccccccccc................................cccccccccccccccccccccccccccccccccccc....................ccccccccccccccccccccccccccccccccccccccccccccc............ddccccccccccccccccccccc.............................................................................................................................................................lbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbccccccccccccccccccccccccccccccccccccccccbbbb....................bbbbbbbbccccccccccccccccccccccccccccccccccccbbbbbbbbbbbbbbbbbbbbccccccccccccccccccccccccccccccccccccccccccccc...............cccccccccccccccccccc.............................................................................................................................................................lcccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc....................ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc...............cccccccccccccccccccc.............................................................................................................................................................lccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccbbbbbbbbbbbbbbbbbbbbccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc...............cccccccccccccccccccc.............................................................................................................................................................lccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc...............cccccccccccccccccccc.............................................................................................................................................................lccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc...............ccccccccccccccccccccd............................................................................................................................................................lcccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccd..............cccccccccccccccccccdd............................................................................................................................................................lccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccd...................cccccccccccccdd............................................................................................................................................................lcccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccd..................cccccccccccccdd............................................................................................................................................................lccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccd.................cccccccccccccdd............................................................................................................................................................lcccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccd................cccccccccccccdd............................................................................................................................................................lccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccd...............cccccccccccccdd............................................................................................................................................................lccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc...............cccccccccccccdd............................................................................................................................................................l..........................................................cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc..................................................................................ccccccccccc...............cccccccccccccdd............................................................................................................................................................l..........................................................cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc..................................................................................ccccccccccc...............cccccccccccccdd............................................................................................................................................................l..........................................................................................................................................................................................................ccccccccccc...................cccccccccdd............................................................................................................................................................l..........................................................................................................................................................................................................ccccccccccc...................cccccccccdddddddddddddddddddddddddddddddddddddddddddddddd..............................................................................................................l..........................................................................................................................................................................................................ccccccccccc...................cccccccccdddddddddddddddddddddddddddddddddddddddddddddddd..............................................................................................................l..........................................................................................................................................................................................................ccccccccccc.......................qqqccddcccccccccccccccccccccccccccccccccccccccccccccc..............................................................................................................l..........................................................................................................................................................................................................cccccccccccd......................qqqccddcccccccccccccccccccccccccccccccccccccccccccccc..............................................................................................................l..........................................................................................................................................................................................................ccccccccccccd.....................qqqccdd............................................................................................................................................................l..........................................................................................................................................................................................................cccccccccccccd....................qqqccdd............................................................................................................................................................l..........................................................................................................................................................................................................ccccccccccccccd...................qqqccdd............................................................................................................................................................l..........................................................................................................................................................................................................cccccccccccccccd..................qqqcc..............................................................................................................................................................l..........................................................................................................................................................................................................ccccccccccccccccd.................qqqcc..............................................................................................................................................................l..........................................................................................................................................................................................................ccccccccccccccccc.................qqrrr..............................................................................................................................................................l..........................................................................................................................................................................................................ccccccccccccccccc.................qrrrr..............................................................................................................................................................l..........................................................................................................................................................................................................ccccccccccccccccc.................qrrrr..............................................................................................................................................................l..........................................................................................................................................................................................................ccccccccccccccccc.................qrrrr..............................................................................................................................................................l..........................................................................................................................................................................................................ccccccccccccccccc.................qrrrr..............................................................................................................................................................l..........................................................................................................................................................................................................cccccccccccccccccdddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd..............................................................................................................l..........................................................................................................................................................................................................ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc..............................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................l...............................................................................................................................................................................................................................................................................................................................................................................................................z0.62;0.85;ice.png;#00000000;#dee9ff;#ccce7c;#8fdada;;;;;;;;#aa9f11;;;#81790c;#413003;#123551;");
				break; //questo diventera' il case 2

			case 8: stringToLevel("tttttttttttttttttttttttttttttttttttl..................................l.aaa.bbb.ccc.dd..eee.fff.gggg.h.h.l.a.a.b.b.c...d.d.e...f...g....h.h.l.aaa.bb..c.P.d.d.eee.fff.g.gg.hhh.l.a.a.b.b.c...d.d.e...f...g..g.h.h.l.a.a.bbb.ccc.dd..eee.f...ggg..h.h.l..................................l..................................l...aaaaaaaaaaaaaaaaaaaaaaaaaaaa...l..................................l..................................l.i.jjjjj.k.k......................l.....j...k.k......................l.i...j...kk.......................l.i.j.j...k.k......................l.i.jjj...k.k......................l..................................l..................................l..................................l...m...m.n...n.ooo.ppp.qqqq.rrr...l...mm.mm.nn..n.o.o.p.p.q..q.r.r...l...m.m.m.n.n.n.o.o.ppp.q..q.rrr...l.X.m...m.n..nn.o.o.p...q.qq.rr....l...m...m.n...n.ooo.p...qqqq.r.r...l..................................z0.62;0.85;ice.png;#000000;#dee9ff;#ccce7c;#8fdada;#d7dc8f;;;;;;;#aa9f11;;;#81790c;#413003;#123551;");
				break;
										
			default:
				alert("Errore nel caricamento del livello - carico il level 1")
				lvlNumber=1;
				leggiLivelloDaFile();
		}
		return
	}

	function stringToLevel(lvlString){			
		level = []; //azzera level
		entity = []; //azzera entity
		var foreground = []; //crea un vettore tipo level per i blocchi di foreground
		var background = []; //crea un vettore tipo level per i blocchi di background
		var widthTot=0;
		var heightTot=1;
		for (i = 0; i < lvlString.length; i++) { //ciclo la stringa livello per trasformarlo da stringa a livello vero
			switch (lvlString[i]){
				case 'X'://posizione iniziale del player
					level['xStartingPos'] = (i%widthTot)*20;
					level['yStartingPos'] = (heightTot-2)*20;
					if(lvlString[i-1]=='p' || lvlString[i-1]=='q' || lvlString[i-1]=='r' ){blockBackground(lvlString[i-1]);} //se il blocco prima era un background lo carica sotto il player
					break;

				case 't': // t √® il top floor/ceiling
					widthTot++;
					break;
					
				case 'l': // l √® il left floor
					heightTot++;
					break;
        
        case 'w': // w funziona come left floor ma indica anche il water level
					heightTot++;
          level['waterLevel'] = ((heightTot-1)*20)+7; //setta il waterlevel
					break;

				case '.': // . √® vuoto/aria
					break;
              
        //ora le entita' (lettere maiuscole)
        case 'P': // P indica un pipistrello
        	var pipistrello = new newPipistrello();
         	pipistrello.x= (i%widthTot)*20;
        	pipistrello.y= (heightTot-1)*20+10;
					entity.push(pipistrello);
					if(lvlString[i-1]=='p' || lvlString[i-1]=='q' || lvlString[i-1]=='r' ){blockBackground(lvlString[i-1]);} //se il blocco prima era un background lo carica sotto la entita' letta
					break;
          
        case 'S': //S sono le spike (le spine che instaKillano)
          var spike= new newSpike();
          spike.x= (i%widthTot)*20;
        	spike.y= (heightTot-1)*20; 
					entity.push(spike);
          break;  							

				//i blocchi
				case 'a': case 'b': case 'c': case 'd': case 'e': case 'f': case 'g': case 'h': case 'i': case 'j': case 'k': 
					// le lettere dalla a alla k indicano un blocco da 25px*25px di colori diversi
					var blocco = new Blocco(i,widthTot,heightTot);
					for (n=1; ;n++){	//controllo che se le lettere dopo sono uguali a questo blocco. Se lo sono non sto a creare tanti blocchetti ma ne faccio solo uno piu' largo per ottimizzare
							if(lvlString[i+n]==lvlString[i]){
								blocco.width=blocco.width+(20);
							}else{
								i=i+n-1;
								break; //del for
							}
					}
					blocco.width=blocco.width+1;
					blocco['lettera'] = lvlString[i];
					level.push(blocco);
					break;

				case 'm': case 'n': case 'o'://foreground
					blockForeground(lvlString[i]);
					break;

				case 'p': case 'q': case 'r'://background 
					blockBackground(lvlString[i]);
					break;	
											
				case 'z': // 'z' indica la fine del livello. Da qui in poi non sto leggendo piu blocchi e entita' ma le caratteristiche del livello come gravita', posizione iniziale del player e colore dei blocchi del livello
					widthTot++;
					heightTot++;
					level['gravity'] = readNumber();
					level['friction'] = readNumber();
          level['gravityWater'] = level.gravity*4/7;
          level['frictionWater'] = level.friction*9/10;
					level['backGroundImg'] = readBackground();
					blocksColors();//this will push color[] to level, it will contain the blocks colors
					foregroundColors();
					backgroundColors();
					level['foreground'] = foreground;
					level['background'] = background;
					break;
			}//fine dello switch case															
		}//fine del for
					        
		//imposto la grandezza del livello e lo confronto con la grandezza del canvas
		level['maxWidth'] = widthTot*20;
		level['maxHeight'] = heightTot*20;
        if (level.maxWidth < canvas.width){ //controlla che il livello non sia piu piccolo del canvas, che se no si bugga tutto - le x
           		canvasWidth=level.maxWidth;
        }else{
           		canvasWidth=canvas.width;
        }
        if (level.maxHeight < canvas.height){ //controlla che il livello non sia piu piccolo del canvas, che se no si bugga tutto - le y
           		canvasHeight=level.maxHeight;
        }else{
           		canvasHeight=canvas.height;
        }     
		//imposto i colori dei blocchi in base a quello che ho letto
		for(i=0; i<level.length;i++){
			switch(level[i].lettera){
				case 'a': level[i].color=level.color[0]; break;
				case 'b': level[i].color=level.color[1]; break;
				case 'c': level[i].color=level.color[2]; break;
				case 'd': level[i].color=level.color[3]; break;
				case 'e': level[i].color=level.color[4]; break;
				case 'f': level[i].color=level.color[5]; break;
				case 'g': level[i].color=level.color[6]; break;
				case 'h': level[i].color=level.color[7]; break;
				case 'i': level[i].color=level.color[8]; break;
				case 'j': level[i].color=level.color[9]; break;
				case 'k': level[i].color=level.color[10]; break;
			}
		}
		for(i=0; i<level.foreground.length;i++){
			switch(level.foreground[i].lettera){
				case 'm': level.foreground[i].color=level.foreground.color[0]; break;
				case 'n': level.foreground[i].color=level.foreground.color[1]; break;
				case 'o': level.foreground[i].color=level.foreground.color[2]; break;
			}
		}
		for(i=0; i<level.background.length;i++){
			switch(level.background[i].lettera){
				case 'p': level.background[i].color=level.background.color[0]; break;
				case 'q': level.background[i].color=level.background.color[1]; break;
				case 'r': level.background[i].color=level.background.color[2]; break;
			}
		}				
    //ora inizializzo i bordi - ho schiacciato il codice perche' occupava righe inutili. e' molto simile al prototipo di blocco    
		var ground = {x: 0, width: level.maxWidth, height: (20)+1, color: level.color[0]};  ground['y']=level.maxHeight-ground.height;
    var ceiling = {x: 0, y: 0, width: level.maxWidth, height: (20)+1, color: level.color[0]};        	            
    var leftWall = {x: 0, y: 0, width: (20)+1, height: level.maxHeight, color: level.color[0]};
    var rightWall = {y: 0, width: (20)+1, height: level.maxHeight, color: level.color[0]}; rightWall['x']= level.maxWidth-rightWall.width;	            				
		level.push(ground, ceiling, leftWall, rightWall); //this pushes all of the static objects into the level				   

    // ora definisco le funzioni interne di stringToLevel()
		function readNumber(){//compone i vari caratteri di una stringa in numero. Esempio traduce "10.91;" in numeroLetto=10.91
			var numeroLetto=0;
			var isDecimale=false;
			var esponente=0;
			for (i++ ; i < lvlString.length; i++) {
				if (lvlString[i] != ";"){
					if (lvlString[i]=='.' || lvlString[i]==','){ //determina se il numero che sto leggendo avra' delle cifre decimali
						isDecimale=true;
					}else{
						if(!isDecimale){
							numeroLetto=(numeroLetto*10)+Number(lvlString[i]);
						}else{
							esponente--;
							numeroLetto=numeroLetto+(Number(lvlString[i])*Math.pow(10,esponente))
						}
					}
				}else{
					break;
				}			
			}
			return numeroLetto;
		}
		function readBackground(){
			var immagineLetta="";
			if (i < lvlString.length){
				for (i++ ; i < lvlString.length; i++) {
					if (lvlString[i] != ";"){
						immagineLetta+=lvlString[i]
					}else{
						break;
					}
				}
			}
			if (immagineLetta!=""){
				return document.getElementById(immagineLetta);
			}else{
				return immagineLetta;
			}
		}
		function readColor(){
			var coloreLetto="";
			if (i < lvlString.length){
				for (i++ ; i < lvlString.length; i++) {
					if (lvlString[i] != ";"){
						coloreLetto+=lvlString[i]
					}else{
						break;
					}
				}
			}
			if (coloreLetto==""){
				return "#155261";
			}else{
				return coloreLetto;
			}						
		}
		function blocksColors(){
			var color = [];
			for (n=0; n<11; n++){
				color[n]=readColor();	
			}
			level['color']=color;
		}
		function foregroundColors(){
			var color = [];
			for (n=0; n<3; n++){
				color[n]=readColor();
			}
			foreground['color']=color;
		}
		function backgroundColors(){
			var color = [];
			for (n=0; n<3; n++){
				color[n]=readColor();	
			}
			background['color']=color;
		}				
		function blockForeground(lettera){
			var blocco = new Blocco(i,widthTot,heightTot);
			for (n=1; ;n++){	//controllo che se le lettere dopo sono uguali a questo blocco. Se lo sono non sto a creare tanti blocchetti ma ne faccio solo uno piu' largo per ottimizzare
					if(lvlString[i+n]==lettera){
						blocco.width=blocco.width+(20);
					}else{
						i=i+n-1;
						break; //del for
					}
			}
			blocco.width=blocco.width+1;
			blocco['lettera'] = lettera;
			foreground.push(blocco);
		}
		function blockBackground(lettera){
			var blocco = new Blocco(i,widthTot,heightTot);
			for (n=1; ;n++){	//controllo che se le lettere dopo sono uguali a questo blocco. Se lo sono non sto a creare tanti blocchetti ma ne faccio solo uno piu' largo per ottimizzare
					if(lvlString[i+n]==lettera){
						blocco.width=blocco.width+(20);
					}else{
						i=i+n-1;
						break; //del for
					}
			}
			blocco.width=blocco.width+1;
			blocco['lettera'] = lettera;
			background.push(blocco);			
		}					
		function Blocco(i,widthTot,heightTot) { //prototipo di blocco
           	this.x= (i%widthTot)*20;
            this.y= (heightTot-1)*20;
            this.width= 20;
      		  this.height= 20+1;
            this.color= '#155261';            													
		}					
	}//fine di stringToLevel()
      
      var entity = []; //create the entity array. Ogni entit√† deve avere: x, y, width, height e il metodo physics che determiner√† come si comporta l'entit√†
      //adesso inizio i prototipi delle entita'
      function newSparo() {//lo sparo creato dal player
        this.life= 1;
        this.type= "sparoDelPlayer";
        this.damage= 1;
        this.x= player.x;
        this.y= player.y+10;
        this.xv= 0;
        this.width= 20;
        this.height= 10;
        this.color= player.charge0color;
        this.speed= 3.9;
        this.facingRight= player.facingRight;
        this.perforation= false;
        this.hasPhysics=true;
        this.physics= function( xdisegnata, ydisegnata, indiceDiQuestaEntity){
          //movimento dello sparo
          if (this.facingRight){
            this.xv -= this.speed;
          }else{
            this.xv += this.speed;
          }
          this.xv *= level.friction;
          this.x += -this.xv;    
          //collisione dello sparo con level
          for (i=0; i<level.length;i++){
            if (collisionBetween(this,level[i])){
              this.life--;
            }
          }
          //collisione dello sparo con altre entita'
          for (i=0; i<entity.length;i++){
            if (!(i == indiceDiQuestaEntity)){
              if ( entity[i].life > 0 && !(this.type == entity[i].type)  && collisionBetween(this,entity[i]) ){	//controlla che l'entita da colpire sia viva, che non siano lo stesso proiettile e infine se c'√® una collisione
                entity[i].life-=this.damage;
                if (!(entity[i].life < 1 && this.perforation)){
                  this.life--;
                }
              }
            }
          }
        }
      }

      function newPipistrello() {//mostro pipistrello
        this.life= 1;
        this.type= "mostro";
        this.damage= 1;
        this.x= 0;
        this.y= 0;
        this.xv= 0;
        this.yv= 0;
        this.slope = 0;
        this.width= 30;
        this.height= 30;
        this.color= '#a400ff';
        this.speed= 0.5;
        this.hasPhysics=true;
        this.physics= function( xdisegnata, ydisegnata, indiceDiQuestaEntity){
          //movimento
          if (this.x < player.x-1){
            this.xv -= this.speed;
          }else if(this.x > player.x+player.width-1){
            this.xv += this.speed;
          }
          if (this.y < player.y+1){
            this.yv -= this.speed;
          }else{
            this.yv += this.speed;
          }
          this.xv *= level.friction;
          this.yv *= level.friction;
          this.x += -this.xv;
          this.y += -this.yv;   
          
          this.slope = 0;	//serve per i bordi tipo
          for(var i = 0; i < level.length; i++) {
            if(collisionBetween(this, level[i])) {
              if(this.slope != -8) {
                this.y -= 1;
                this.slope += 1;
              }
            }
          }
          // level collision
          for(var i = 0; i < level.length; i++) {
            if(collisionBetween(this, level[i])) {
              this.y += this.slope;
              this.x += this.xv*2;
              this.xv = 0;
            } 
            if(collisionBetween(this, level[i])) {
              this.y += this.yv*2;
              this.yv = 0;
            }   
          }
          //other entity mostro collision - e' un po buggata
          for(var i = 0; i < entity.length; i++) {
          	if (entity[i].life > 0 && entity[i].type=="mostro" && !(i==indiceDiQuestaEntity)){
            	if(collisionBetween(this, entity[i])) {
              		this.x += this.xv*1.95;
              		this.xv = 0;
					this.y += this.yv*1.95;
					this.yv = 0;
            	}  
            }
          }
          //collision col player
          if(collisionBetween(this, player)) {
        	this.xv = 0;
			this.yv = 0;		
          }            
        }              
      }
                  
      function newSpike() {//mostro pipistrello
        this.life= 9999999999;
        this.type= "ostacolo";
        this.damage= 9999999999;
        this.x= 0;
        this.y= 0;
        this.width= 20;
        this.height= 20;
        this.canSelfDraw=true;
        this.hasPhysics=false;
        this.color= '#bcbcbc';
        this.selfDraw= function( xdisegnata, ydisegnata, indiceDiQuestaEntity){
          //funzione per disegnare la spina
        	ctx.beginPath();
		      ctx.lineWidth = "1";
		      ctx.fillStyle = this.color;
		      ctx.moveTo(xdisegnata, ydisegnata+this.height);
		      ctx.lineTo(xdisegnata+this.width, ydisegnata+this.height);
          ctx.lineTo(xdisegnata+(this.width/2), ydisegnata-2);
          ctx.lineTo(xdisegnata, ydisegnata+this.height);
		      ctx.fill();
        }              
      }      
      			
  //start the engine
  window.onload = start;
            
  //this function is called at the start
	function start() {
    update();
	}
	
  function nuovoLivello(){	//azzera i dati del player e carica un nuovo livello (da stringa e non da file...)
		player = new Player();
		leggiLivelloDaFile();
    player.x = level.xStartingPos;
    player.y = level.yStartingPos;
	}
                                
  function update() {//this function is called every frame
    requestAnimationFrame(update); //credo che sia la roba che crea il ciclo del gioco
    if (stageSelection){
      stageSelect();
    }else if (menuDiPausa){
      objMenuDiPausa.drawMenuDiPausa();
    }else{
      disegnaSchermoDiGioco(true); //ATTENZIONE: se le viene passato true oltre a disegnare le entita' calcola anche le lore physics
      playerPhysics(player, level); //chiama la funzione physics del player
    }
  }
      
      function disegnaSchermoDiGioco(doEntityPhysics){
          ctx.clearRect(0, 0, canvas.width, canvas.height);	//pulisci tutto il canvas
          drawBackgroundImage();
          drawLvl(level.background);//disegna i blocchi non materiali che colorano lo sfondo (passa false come isDrawingWater - non disegna l'acqua)
          drawLvl(level);//disegna i blocchi fisici del livello (passa false come isDrawingWater - non disegna l'acqua)
          drawHUD(); //if you move drawHUD() under playerPhysics() the HUD will always be drawn on top of everything, but i like it this way. Entities and the player are more important then the hud lol
          drawEntity(doEntityPhysics); //in questa funzione viene chiamata anche il metodo entity[i].physics per le entit√† che vengono disegnate su schermo (le uniche che carico)
          drawPlayer(); //disegna il player
          drawLvl(level.foreground);//disegna i blocchi non materiali che stanno sopra tutto il resto (effetto grafico) e il waterlevel (passa true a isDrawingWater)
          drawWater();
      }

      function xDisegnata(){
        if (player.x+(player.width/2) < canvasWidth/2) {	//se la x del player √® minore di mezzo canvas la tiene com'√®
          xdisegnata=player.x;
        }else{
          if (player.x+(player.width/2) > level.maxWidth-canvasWidth/2){ //altrimenti controlla: se √® in mezzo al livello disegna il player al centro del canvas, altrimenti lo lascia scorrere dal centro verso la fine
              xdisegnata=canvasWidth-level.maxWidth+player.x;
          }else{
              xdisegnata=canvasWidth/2-(player.width/2);	
          }
        }
        return xdisegnata;	
	  }
	  function yDisegnata(){
       if (player.y < canvasHeight/2) {	//se la y del player √® minore di mezzo canvas la tiene com'√®
           ydisegnata=player.y;
        }else{
            if (player.y > level.maxHeight-canvasHeight/2){ //altrimenti controlla: se √® in mezzo al livello disegna il player al centro del canvas, altrimenti lo lascia scorrere dal centro verso la fine
              ydisegnata=canvasHeight-level.maxHeight+player.y;
            }else{
              ydisegnata=canvasHeight/2;	
            }
        }
        return ydisegnata;
	  }
            
      function drawPlayer() {
        var xdisegnata=xDisegnata(); //mi serve per semplificare le scritture dopo, praticamente gestisce la visuale sull asse x
        var ydisegnata=yDisegnata(); //mi serve per semplificare le scritture dopo, praticamente gestisce la visuale sull'asse y  
        //ombre del dash
        if (player.speed>player.defaultspeed){
            if (player.xv < -10){
                ctx.fillStyle =player.color+'45';//aggiunge la trasparenza
                ctx.fillRect(xdisegnata-50, ydisegnata+3, player.width-3, player.height-6);
                ctx.fillStyle =player.color+'90';
                ctx.fillRect(xdisegnata-26, ydisegnata+1, player.width-1, player.height-2);
            }else if (player.xv > 10){
               ctx.fillStyle =player.color+'45';
               ctx.fillRect(xdisegnata+50+3, ydisegnata+3, player.width-3, player.height-6);
               ctx.fillStyle =player.color+'90';
               ctx.fillRect(xdisegnata+26+1, ydisegnata+1, player.width-1, player.height-2);
            }
        }
		//ora disegna effettivamente il player
        ctx.fillStyle = player.color;
        ctx.fillRect(xdisegnata, ydisegnata, player.width, player.height);
      }

	function drawBackgroundImage(){//disegna immagine di sfondo
        if(level.backGroundImg != "" && level.backGroundImg != null ){//se esiste disegna lo sfondo
        	ctx.drawImage(level.backGroundImg, 0, 0, canvasWidth,canvasHeight);
        }
	}
  
  function drawWater(){  //disegna l'acqua
      ctx.fillStyle = player.defaultColor + "50";
      var ydisegnata=0
      if (player.y < canvasHeight/2){
        ydisegnata=level.waterLevel;
      }else{
        if (player.y > level.maxHeight-canvasHeight/2){
        ydisegnata=level.waterLevel-level.maxHeight+canvasHeight;
        }else{
          ydisegnata=level.waterLevel-player.y+canvasHeight/2;
        }
      }
      ctx.fillRect(0, ydisegnata, canvasWidth, canvasHeight);        
  }
	          
      //this function draws the level (usata anche per level.foreground e level.background - basta che sia un arrey di oggetti blocco)
      function drawLvl(lvl) {
        for (var i = 0; i < lvl.length; i++) {
          ctx.fillStyle = lvl[i].color;
          //variabili per disegnare il livello rispetto alla posizione di x (rispetto ai bordi del canvas) - visuale
          var xdisegnata=0
          if (player.x+(player.width/2) < canvasWidth/2){
            xdisegnata=lvl[i].x;
          }else{
            if (player.x+(player.width/2) > level.maxWidth-canvasWidth/2){
              xdisegnata=lvl[i].x-level.maxWidth+canvasWidth;
            }else{
              xdisegnata=lvl[i].x-player.x-(player.width/2)+canvasWidth/2;
            }
          }
		  var ydisegnata=0
          if (player.y < canvasHeight/2){
            ydisegnata=lvl[i].y;
          }else{
            if (player.y > level.maxHeight-canvasHeight/2){
              ydisegnata=lvl[i].y-level.maxHeight+canvasHeight;
            }else{
              ydisegnata=lvl[i].y-player.y+canvasHeight/2;
            }
          }
          //ora disegno il livello[i]                    
          ctx.fillRect(xdisegnata, ydisegnata, lvl[i].width, lvl[i].height);
        }
      }

      function drawHUD(){
      	ctx.fillStyle = '#9e9e9e';
		ctx.fillRect(8, 8, player.lifeMax*6+39, 29);
		ctx.fillStyle = '#3d3b3b';
		ctx.fillRect(10, 10, player.lifeMax*6+40, 30);		
		ctx.beginPath();//ora inizio a disegnare la x che sara' del colore del player attivo
		ctx.lineWidth = "7";
		ctx.strokeStyle = player.color;
		ctx.moveTo(15, 15);
		ctx.lineTo(35, 35);
		ctx.stroke(); // Disegna la prima meta'della X
		ctx.moveTo(35, 15);
		ctx.lineTo(15, 35);
		ctx.stroke(); // Disegna la seconda meta'della X
				
		for (i=0; i < player.lifeMax; i++) { //disegno le barre della vita
			if (i < player.life){
				ctx.fillStyle = player.charge0color;
			}else{
				ctx.fillStyle = '#797979';
			}
			ctx.fillRect(i*6+43, 15, 5, 20);
		}
      }
      
      function drawEntity(doEntityPhysics){   //disegna le entit√† a schermo e chiama la entity[i].physics
        for (var i = 0; i < entity.length; i++) {
          if (entity[i].life > 0){ //calcola la entita solo se la sua vita √® maggiore di zero
            ctx.fillStyle = entity[i].color;
            //variabili per disegnare il livello rispetto alla posizione di x (rispetto ai bordi del canvas) - visuale
            var xdisegnata=0;
            if (player.x+(player.width/2) < canvasWidth/2){
              xdisegnata=entity[i].x;
            }else{
              if (player.x+(player.width/2) > level.maxWidth-canvasWidth/2){
                xdisegnata=entity[i].x-level.maxWidth+canvasWidth;
              }else{
                xdisegnata=entity[i].x-player.x-(player.width/2)+canvasWidth/2;
              }
            }
			var ydisegnata=0;
            if (player.y < canvasHeight/2){
              ydisegnata=entity[i].y;
            }else{
              if (player.y > level.maxHeight-canvasHeight/2){
                ydisegnata=entity[i].y-level.maxHeight+canvasHeight;
              }else{
                ydisegnata=entity[i].y-player.y+canvasHeight/2;
              }
            }
            //ora disegno l'entita e chiamo physics se e' dentro il canvas disegnato+unQuartoDiCanvas (questa roba non si applica se √® uno sparo del player - se no si bugga tutto)                    
            if ( (xdisegnata > (-canvasWidth/8) && xdisegnata < (canvasWidth+(canvasWidth/8))) && (ydisegnata > (-canvasHeight/8) && ydisegnata < (canvasHeight+(canvasHeight/8))) || entity[i].type=="sparoDelPlayer") { //questo if fa i controlli spiegati sopra 
              if(entity[i].canSelfDraw){
                  entity[i].selfDraw(xdisegnata,ydisegnata, i);
              }else{
                  ctx.fillRect(xdisegnata, ydisegnata, entity[i].width, entity[i].height);
              }
              if(doEntityPhysics && entity[i].hasPhysics){entity[i].physics(xdisegnata,ydisegnata, i);}
            }
          }
        }
      }
            
      
      function playerPhysics(p1, lvl) {//this function handles the platformer physics - in realta' solo del player
      var gravityApplicata = 0; var frizioneApplicata = 0;
        if (p1.y > level.waterLevel){  //determina se sei in acqua o no
            if (!p1.isInWater){
                p1.isInWater = true;
                p1.yv = 0;
            }
            gravityApplicata = level.gravityWater;
            frizioneApplicata = level.frictionWater;
        }else{
            p1.isInWater = false;
            gravityApplicata = level.gravity;
            frizioneApplicata = level.friction;            
        }
                
        p1.yv += gravityApplicata;//get level gravity
        p1.y += p1.yv;//apply gravity
                        
        for(var i = 0; i < lvl.length; i++) {//y collision
          if(collisionBetween(p1, lvl[i])) {
            p1.y += -p1.yv;            
            if(keys[dashkey] && player.canMove) {//dash
              p1.speed=p1.defaultspeed*2.5;
            }else{
              p1.speed=player.defaultspeed;
            }            
            if(keys[jumpkey] && player.canMove) {//jump
              if(!p1.giasaltato) {
                p1.yv = -p1.jumpheight;
                p1.giasaltato = true;
              } else {
                p1.yv = 0; 
              }
            } else {
              p1.yv = 0;
              p1.giasaltato = false;
            }
          }	
        }        
                       
        if(keys[destrakey] && player.canMove) {//x movement
          p1.xv -= p1.speed;
          player.facingRight = true;
        }
        if(keys[sinistrakey] && player.canMove) {
          p1.xv += p1.speed;
          player.facingRight = false;
        }
        p1.xv *= frizioneApplicata;
        p1.x += -p1.xv;
                
        if(keys[sparokey] && player.canMove) {//shooting
          if(!player.giasparato){
            var sparo = new newSparo();
            entity.push(sparo);
            player.giasparato = true;
          }else{
            player.carica++;//disegna i pallini del colore della carica intorno al player
            if (player.carica > 80){ //level 2 charge
              var xdisegnata=xDisegnata(); var ydisegnata=yDisegnata();
              var xrandom=((-player.width/4)+Math.floor(Math.random() * (player.width/2)))*3; var yrandom=((-player.height/4)+Math.floor(Math.random() * (player.height/2)))*2;
              ctx.fillStyle = player.charge0color;
              ctx.fillRect(xdisegnata+(player.width/2)+xrandom, ydisegnata+(player.height/2)+yrandom, 8, 8);
            }else if(player.carica > 25){ //level 1 charge
              var xdisegnata=xDisegnata(); var ydisegnata=yDisegnata();
              var xrandom=((-player.width/4)+Math.floor(Math.random() * (player.width/2)))*3; var yrandom=((-player.height/4)+Math.floor(Math.random() * (player.height/2)))*2;
              ctx.fillStyle = player.charge1color;
              ctx.fillRect(xdisegnata+(player.width/2)+xrandom, ydisegnata+(player.height/2)+yrandom, 8, 8);
            }   
          }
        }else{
          if (player.giasparato){
            if (player.carica > 80){
            	var sparo = new newSparo();
                sparo.width= 50;
                sparo.height= 25;
                if (!sparo.facingRight){
                	sparo.x= sparo.x-player.width;
                }
                sparo.y= player.y+5;
                sparo.color= player.charge2color;
                sparo.perforation=true;
                entity.push(sparo);
            }else if (player.carica > 25){
            	var sparo = new newSparo();
            	sparo.width= 35;
            	sparo.height= 15;
            	sparo.color= player.charge1color;
            	entity.push(sparo);
            }
            player.color=player.defaultColor ;
            player.carica=0;
            player.giasparato=false;
          }
        }
                
        p1.slope = 0;	//serve per i bordi tipo - serve anche per le x collision
        for(var i = 0; i < lvl.length; i++) {
          if(collisionBetween(p1, lvl[i])) {
            if(p1.slope != -8) {
              p1.y -= 1;
              p1.slope += 1;
            }
          }
        }

       	for(var i = 0; i < lvl.length; i++) {//x collision
          if(collisionBetween(p1, lvl[i])) {
            p1.y += p1.slope;
            p1.x -= -p1.xv;
            if(keys[dashkey] && player.canMove) {//wall dash
              p1.speed=p1.defaultspeed*2.5;
            }else{
              p1.speed=player.defaultspeed;
            }           
            if(keys[jumpkey] && player.canMove) {//wall jumping
              if(!p1.giasaltato) { 
                p1.yv = -p1.jumpheight + 1;
                if(p1.xv > 0) {
                  p1.xv = -10;
                } else {
                  p1.xv = 10;
                }
                p1.giasaltato = true;
              } else {
                p1.xv = 0;
              }
            } else {
              p1.xv = 0;
              p1.giasaltato = false;
            }   
          }
        }
      
        if (player.invulnerability < 1){//entity collison
		for(var i = 0; i < entity.length; i++) {
			if(entity[i].life > 0 && !(entity[i].type=="sparoDelPlayer")) {
              			if(collisionBetween(player, entity[i])) {
				    player.color=player.damagedColor;
				    player.life=player.life-entity[i].damage;
				    player.invulnerability=40;
				    player.canMove=false;
				    break;
            			}
        		}
        	}
       	}else{
       		player.invulnerability--;
       		if (player.invulnerability < 30){
       			player.color=player.defaultColor+'80';
       		}
       		if (player.invulnerability < 20){
       			player.canMove=true;
       		}       		
       		if (player.invulnerability < 5){
       			player.color=player.defaultColor;    			
       		}	
       	}
      	
      	if(player.life<1){//gameover
      		disegnaSchermoDiGioco(false);
      		alert("Gameover");
      		stageSelection=true;
      	}
        
        if(keys[startkey]) {//menu di pausa
          objMenuDiPausa=new newMenuDiPausa();
          disegnaSchermoDiGioco(false);
          menuDiPausa=true;
        }
         
      } //fine della funzione playerPhysics - se riesco la faccio diventare un metodo di player invece che una funzione sestante
          
      function collisionBetween(p1, lvl) {//this function detects the collision between the two given objects - la uso anche con le entit√† lol
        if (lvl.x < p1.x + p1.width 
        && lvl.x + lvl.width > p1.x 
        && lvl.y < p1.y + p1.height 
        && lvl.y + lvl.height > p1.y) {
                return true;
        } else {
                return false;
        } 
      }     

      function stageSelect(){
          var img = document.getElementById("stageselect");
          ctx.drawImage(img, 0, 0, canvasWidth,canvasHeight);
            //leggo che tasto viene schiacciato. Con invio o dash si inizia a giocare, con le freccie si cicla tra i livelli
            if (keys[startkey] || keys[dashkey]){
              stageSelection=false;
              nuovoLivello();
            }
            if (keys[sukey] && !tastoGiaSchiacciato){
             if(lvlNumber==4){lvlNumber=3; }else if(lvlNumber==5){lvlNumber=2;}else if(lvlNumber==6){lvlNumber=1;}else if(lvlNumber==7){lvlNumber=8;}else if(lvlNumber==3){lvlNumber=2;}else if(lvlNumber==8){lvlNumber=1;}             
            }
            if (keys[giukey] && !tastoGiaSchiacciato){
             if(lvlNumber==1){lvlNumber=6;}else if(lvlNumber==2){lvlNumber=5;}else if(lvlNumber==3){lvlNumber=4;}else if(lvlNumber==8){lvlNumber=7;}else if(lvlNumber==7){lvlNumber=6;}else if(lvlNumber==4){lvlNumber=5;}                      
            }
            if (keys[sinistrakey] && !tastoGiaSchiacciato){
             if(lvlNumber==2){lvlNumber=1;}else if(lvlNumber==3){lvlNumber=8;}else if(lvlNumber==4){lvlNumber=7;}else if(lvlNumber==5){lvlNumber=6;}else if(lvlNumber==1){lvlNumber=8;}else if(lvlNumber==6){lvlNumber=7;}                 
            }
            if (keys[destrakey] && !tastoGiaSchiacciato){
             if(lvlNumber==1){lvlNumber=2;}else if(lvlNumber==2){lvlNumber=3;}else if(lvlNumber==5){lvlNumber=4;}else if(lvlNumber==6){lvlNumber=5;}else if(lvlNumber==7){lvlNumber=4;}else if(lvlNumber==8){lvlNumber=3;} 
            }            
            if(keys[destrakey] || keys[sinistrakey] || keys[giukey] || keys[sukey]){ //serve per evitare che in un attimo ti sposti di un bordello di livelli 
                   tastoGiaSchiacciato=true;
            }else{ tastoGiaSchiacciato=false;}
            
            //ora disegno un quadrato intorno al livello selezionato
            ctx.fillStyle = player.charge0color;
            switch (lvlNumber){
              case 1:ctx.fillRect(137, 10, 135, 10);ctx.fillRect(137, 10, 10, 135);ctx.fillRect(137, 135, 135, 10);ctx.fillRect(263, 10, 10, 135);break;                
              case 2:ctx.fillRect(265, 10, 135, 10);ctx.fillRect(265, 10, 10, 135);ctx.fillRect(265, 135, 135, 10);ctx.fillRect(391, 10, 10, 135);break;                
              case 3:ctx.fillRect(395, 140, 135, 10);ctx.fillRect(395, 140, 10, 135);ctx.fillRect(395, 265, 135, 10);ctx.fillRect(521, 140, 10, 135);break;                
              case 4:ctx.fillRect(395, 270, 135, 10);ctx.fillRect(395, 270, 10, 135);ctx.fillRect(395, 395, 135, 10);ctx.fillRect(521, 270, 10, 135);break;                
              case 5:ctx.fillRect(265, 396, 135, 10);ctx.fillRect(265, 396, 10, 135);ctx.fillRect(265, 521, 135, 10);ctx.fillRect(391, 396, 10, 135);break;                
              case 6:ctx.fillRect(137, 396, 135, 10);ctx.fillRect(137, 396, 10, 135);ctx.fillRect(137, 521, 135, 10);ctx.fillRect(263, 396, 10, 135);break;                
              case 7:ctx.fillRect(9, 270, 135, 10);ctx.fillRect(9, 270, 10, 135);ctx.fillRect(9, 395, 135, 10);ctx.fillRect(135, 270, 10, 135);break;                
              case 8:ctx.fillRect(9, 140, 135, 10);ctx.fillRect(9, 140, 10, 135);ctx.fillRect(9, 265, 135, 10);ctx.fillRect(135, 140, 10, 135);break;                                                                                                                
            }
      }
      
      function newMenuDiPausa(){
        this.width=0;
        this.height=0;
        this.widthMax=canvasWidth-150;
        this.heightMax=canvasHeight-150;
        this.isOpen=false;
        this.isClosing=false;
        this.drawMenuDiPausa = function (){
          if (!this.isOpen && !this.isClosing){
            if (this.width < this.widthMax){this.width+=10;}
            if (this.height < this.heightMax){this.height+=15;}
            if (this.height > this.heightMax-1 && this.width > this.widthMax-1){this.isOpen=true;}
          }
          ctx.clearRect((canvasWidth/2)-this.width/2-15,(canvasHeight/2)-this.height/2-15, this.width+30, this.height+30);	//pulisci la parte dove viene mostrato il menu
          ctx.fillStyle = "#d2d2d2"; ctx.fillRect((canvasWidth/2)-this.width/2-15,(canvasHeight/2)-this.height/2-15, this.width+30, this.height+30); //disegna il bordo grigio 
          ctx.fillStyle = "#52b58b"; ctx.fillRect((canvasWidth/2)-this.width/2,(canvasHeight/2)-this.height/2, this.width, this.height); //disegna lo sfondo verde
          if (this.isOpen){ //qui dentro devo mostrare il testo del menu e gestire cosa succede quando schiaccio i tasti
              if(keys[startkey] || keys[jumpkey]) {//esci dal menu di pausa
                this.isClosing=true;
                this.isOpen=false;
              }
          }
          if(this.isClosing){
              if (this.width > 0){this.width-=20;}
              if (this.height > 0){this.height-=20;}
              ctx.clearRect((canvasWidth/2)-this.width/2-15,(canvasHeight/2)-this.height/2-15, this.width+30, this.height+30);	//pulisci la parte dove viene mostrato il menu
              disegnaSchermoDiGioco(false);
              ctx.fillStyle = "#d2d2d2"; ctx.fillRect((canvasWidth/2)-this.width/2-15,(canvasHeight/2)-this.height/2-15, this.width+30, this.height+30); //disegna il bordo grigio 
              ctx.fillStyle = "#52b58b"; ctx.fillRect((canvasWidth/2)-this.width/2,(canvasHeight/2)-this.height/2, this.width, this.height); //disegna lo sfondo verde
              if (this.height-1 < 0 && this.width-1 < 0){
                  menuDiPausa=false;
              }             
          }
        }     
      }
       